# 贪吃蛇游戏 - 最新更新说明

## 📅 更新日期：2026-01-08

---

## ✨ 新增功能

### 1. 管理员会话管理

**问题：** 之前刷新页面就会退出登录，每次都需要输入密码和验证码

**解决方案：**
- ✅ 添加管理员登录状态保持功能
- ✅ 刷新页面不会退出登录
- ✅ 5分钟无操作自动退出登录
- ✅ 实时会话检查（每30秒检查一次）
- ✅ 点击"退出登录"按钮才会真正退出

**工作原理：**
1. 登录成功后，记录登录时间到 localStorage
2. 启动定时器，每30秒检查一次会话状态
3. 每次访问管理后台，更新登录时间（刷新超时计时）
4. 超过5分钟未操作，自动清除登录状态
5. 刷新页面时，检查是否超时，未超时则保持登录状态

**修改的文件：**
- `js/router.js`

**新增的变量：**
```javascript
adminLoginTime: null,              // 管理员登录时间
adminSessionTimeout: 5 * 60 * 1000,  // 5分钟超时（毫秒）
sessionCheckInterval: null,         // 会话检查定时器
```

**新增的方法：**
```javascript
startSessionCheck()      // 启动会话检查定时器
stopSessionCheck()       // 停止会话检查定时器
logoutAdmin()            // 退出管理员登录（增强版）
```

---

## 🔧 部署更新

### 上传修改后的文件

```bash
# 在本地电脑执行
scp "d:/ftp/贪吃蛇/js/router.js" root@8.138.27.63:/opt/snake-game/js/
```

或使用 WinSCP/FileZilla 上传 `js/router.js` 文件。

### 重启服务

```bash
# 在服务器上执行
systemctl restart snake-game
```

### 验证更新

1. 访问 `https://8.138.27.63/admin`
2. 输入密码和验证码登录
3. 刷新浏览器页面（F5 或 Ctrl+R）
4. **应该保持登录状态**，不需要重新输入密码
5. 等待5分钟不操作
6. **应该自动退出登录**，提示重新登录

---

## 📋 功能说明

### 管理员登录超时机制

| 操作 | 行为 |
|------|------|
| 登录成功 | 记录登录时间，启动会话检查 |
| 刷新页面 | 更新登录时间（刷新超时计时） |
| 切换标签页 | 保持登录状态（会话检查继续运行） |
| 5分钟无操作 | 自动退出登录 |
| 点击"退出登录"按钮 | 立即退出登录 |

### 会话检查机制

- **检查频率**: 每30秒检查一次
- **超时时间**: 5分钟（300秒）
- **更新机制**: 每次访问管理后台自动刷新登录时间
- **存储方式**: localStorage

---

## 🔒 安全建议

### 1. 修改默认密码

首次登录后，立即修改默认管理员密码 `admin123`。

### 2. 启用 MFA 双因素认证

在管理后台启用 MFA 功能，使用 TOTP 应用进行二次验证。

### 3. 定期检查登录日志

在管理后台查看登录日志，及时发现异常登录。

### 4. 限制管理员访问

可以在 Nginx 配置中添加 IP 白名单：

```nginx
# 只允许特定 IP 访问管理后台
location /admin {
    allow 8.138.27.63;  # 你的管理员 IP
    allow 1.2.3.4;       # 其他允许的 IP
    deny all;

    proxy_pass http://127.0.0.1:8888;
    ...
}
```

---

## 📊 测试清单

- [ ] 登录成功后，刷新页面保持登录状态
- [ ] 切换浏览器标签页，登录状态保持
- [ ] 5分钟无操作，自动退出登录
- [ ] 点击"退出登录"按钮，立即退出
- [ ] 登录超时后，显示提示信息
- [ ] 游戏功能正常

---

## 🛠️ 故障排除

### 问题1：刷新后仍然退出登录

**原因：** 浏览器禁用了 localStorage

**解决：**
1. 检查浏览器设置
2. 清除浏览器缓存和 Cookie
3. 尝试使用隐身模式

### 问题2：会话检查不工作

**原因：** JavaScript 错误或文件未正确上传

**解决：**
1. 打开浏览器控制台（F12）
2. 查看是否有 JavaScript 错误
3. 确认 `js/router.js` 已正确上传
4. 重启 Node.js 服务

### 问题3：自动退出时间不准确

**原因：** 系统时间不准确

**解决：**
1. 同步服务器时间
2. 检查客户端时间是否准确

---

## 📝 代码修改说明

### 修改位置1：Router 对象初始化

**文件：** `js/router.js` 第 2-8 行

**添加内容：**
```javascript
adminLoginTime: null,              // 管理员登录时间
adminSessionTimeout: 5 * 60 * 1000,  // 5分钟超时（毫秒）
sessionCheckInterval: null,         // 会话检查定时器
```

### 修改位置2：renderAdminPage 方法

**文件：** `js/router.js` 第 1001-1011 行

**修改内容：**
- 添加登录超时检查
- 添加登录时间更新
- 启动会话检查

### 修改位置3：handleAdminLogin 方法

**文件：** `js/router.js` 第 861-862 行 和 第 875 行

**修改内容：**
- 登录成功后，保存登录时间到 localStorage

### 修改位置4：新增方法

**文件：** `js/router.js` 第 1428 行后

**新增方法：**
```javascript
startSessionCheck()      // 启动会话检查定时器
stopSessionCheck()       // 停止会话检查定时器
```

---

## 🎯 使用示例

### 正常使用流程

1. 访问 `https://8.138.27.63/admin`
2. 输入密码和验证码登录
3. 登录成功后，可以进行管理操作
4. **刷新页面（F5）**，仍然保持登录状态 ✅
5. 切换到其他标签页，再切回来，仍然保持登录状态 ✅
6. **等待5分钟不操作**，自动退出登录 ✅
7. 或点击"退出登录"按钮，立即退出 ✅

### 修改会话超时时间

如果需要修改超时时间，编辑 `js/router.js`：

```javascript
// 找到这一行
adminSessionTimeout: 5 * 60 * 1000,  // 5分钟超时（毫秒）

// 修改为你想要的时间（单位：分钟）
// 例如：10分钟
adminSessionTimeout: 10 * 60 * 1000,  // 10分钟超时（毫秒）

// 例如：30分钟
adminSessionTimeout: 30 * 60 * 1000,  // 30分钟超时（毫秒）
```

---

## 📞 技术支持

如遇到问题，请检查：

1. 浏览器控制台是否有 JavaScript 错误
2. localStorage 是否可用
3. `js/router.js` 文件是否正确上传
4. Node.js 服务是否正常运行
5. 浏览器缓存是否清除

---

**更新版本**: v3.1
**更新日期**: 2026-01-08
**更新内容**: 管理员会话管理、文档去敏感信息
